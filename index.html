<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Catálogo de análisis cartográficos</title>
    <meta name="author" content="Derek Eder">
    <meta content="Display any CSV file as a searchable, filterable, pretty HTML table" />

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/select2.min.css" rel="stylesheet">
    <style type="text/css">
      .sombra {
        box-shadow: 0 1px 2px rgba(0,0,0,0.15);
        transition: box-shadow 0.3s ease-in-out;
      }

      .sombra:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.8)
      }

      .pointer{
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="row mt-5">
        <h2>Catálogo de análisis cartográficos</h2>
      </div>

      <div class="row mt-5">
        <div class="col-4">
          <select class="js-states form-control" id="filtro_status" multiple="multiple" onchange="filter()">
          </select>
        </div>
        <div class="col-4">
          <select class="js-states form-control" id="filtro_gerencia" multiple="multiple" onchange="filter()">
          </select>
        </div>
        <div class="col-4">  
          <select class="js-states form-control" id="filtro_tematica_prin" multiple="multiple" onchange="filter()">
          </select>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-4">
          <select class="js-states form-control" id="filtro_tematica_sec" multiple="multiple" onchange="filter()">
          </select>
        </div>
        <div class="col-4">
          <select class="js-states form-control" id="filtro_analisis" multiple="multiple" onchange="filter()">
          </select>
        </div>
        <div class="col-4 input-group mb-3">
          <input type="text" class="form-control" id="filtro_libre" placeholder="Buscar">
          <div class="input-group-prepend">
            <button class="btn btn-outline-secondary" type="button" onclick="filter()">Buscar</button>
          </div>
        </div>
      </div>

      <nav class="mt-5">
        <p class="text-right" id="pagination_top"></p>
        <ul class="pagination justify-content-end">
          <li id="page_back_top" class="page-item disabled pointer">
            <a class="page-link" onclick="changePagination('back');">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          <li id="page_next_top" class="page-item pointer">
            <a class="page-link" onclick="changePagination('next');">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>
 
      <div class="row mt-3" id='table'>
        <!--<div id='table'></div>-->
      </div>

      <nav class="mt-5">
        <p class="text-right" id="pagination_bottom"></p>
        <ul class="pagination justify-content-end">
          <li id="page_back_bottom" class="page-item disabled pointer">
            <a class="page-link" onclick="changePagination('back');">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          <li id="page_next_bottom" class="page-item pointer">
            <a class="page-link" onclick="changePagination('next');">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>

    <!--<footer class='footer'>
      <div class='container'>
        <hr />
        <p class='pull-right'><a href='http://imeplan.mx/'>CSV to HTML Table</a> by <a href='http://imeplan.mx/'>IMEPLAN</a></p>
      </div>
    </footer>-->

    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/select2.min.js"></script>
    <script type="text/javascript" src="js/papaparse.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript">
        var filter_status, filter_gerencia, filter_tematica_prin, filter_tematica_sec, filter_tipo, data_csv, temp = [];
        var start_pagination = 0, limit_pagination = 25, page = 1;

      $(document).ready(function(){
        $("#filtro_status").select2({
          width: 'resolve',
          language: "es",
          placeholder: 'Estatus del análisis'
        });
        $("#filtro_gerencia").select2({
          width: 'resolve',
          language: "es",
          placeholder: 'Gerencia'
        });
        $("#filtro_tematica_prin").select2({
          width: 'resolve',
          language: "es",
          placeholder: 'Temática principal LGAHOTDU'
        });
        $("#filtro_tematica_sec").select2({
          width: 'resolve',
          language: "es",
          placeholder: 'Temática secundaria LGAHOTDU'
        });
        $("#filtro_analisis").select2({
          width: 'resolve',
          language: "es",
          placeholder: 'Tipo de análisis'
        });
        var config = {download: true, delimiter: ","};
        var file = "data/rac_18022020.csv";

        var csv = Papa.parse(file, {
                                    download: true, delimiter: ",",
                                    complete: function(results) {
                                      //
                                      data_csv = results.data;
                                      data_csv.splice(0,1);
                                      console.log(data_csv)

                                      data_csv.forEach( function (datos, index){
                                        if(!($("#filtro_status option[value='"+datos[5]+"']").length > 0) && datos[5] != ''){
                                          $("#filtro_status").append("<option value='"+datos[5]+"'>"+datos[5]+"</option>");
                                        }
                                        if(!($("#filtro_gerencia option[value='"+datos[6]+"']").length > 0) && datos[6] != ''){
                                          $("#filtro_gerencia").append("<option value='"+datos[6]+"'>"+datos[6]+"</option>");
                                        }
                                        if(!($("#filtro_tematica_prin option[value='"+datos[9]+"']").length > 0) && datos[9] != ''){
                                          $("#filtro_tematica_prin").append("<option value='"+datos[9]+"'>"+datos[9]+"</option>");
                                        }
                                        if(!($("#filtro_tematica_sec option[value='"+datos[10]+"']").length > 0) && datos[10] != ''){
                                          $("#filtro_tematica_sec").append("<option value='"+datos[10]+"'>"+datos[10]+"</option>");
                                        }
                                        if(!($("#filtro_analisis option[value='"+datos[11]+"']").length > 0) && datos[11] != ''){
                                          $("#filtro_analisis").append("<option value='"+datos[11]+"'>"+datos[11]+"</option>");
                                        }
                                      });
                                      $("#filtro_status option[value='undefined']").remove();
                                      $("#filtro_gerencia option[value='undefined']").remove();
                                      $("#filtro_tematica_prin option[value='undefined']").remove();
                                      $("#filtro_tematica_sec option[value='undefined']").remove();
                                      $("#filtro_analisis option[value='undefined']").remove();

                                      //first view
                                      buildElements(results.data, start_pagination, limit_pagination);
                                      //get pagination
                                      totalPages = Math.ceil(data_csv.length / 25);
                                      $("#pagination_top").html("Página "+page+" - "+totalPages+" / "+data_csv.length);
                                      $("#pagination_bottom").html("Página "+page+" - "+totalPages+" / "+data_csv.length);

                                    }
                                  });
      });
      function buildElements(csv_data, start, limit){
        $("#table").html('');
        var status, color, link, tiulo_proyecto, titulo, gerencia, tematica_prin, tematica_sec, analisis, miniatura;
        for(var i = start; i < limit; i++){
          status = (csv_data[i][5] != '')? csv_data[i][5] : 'Sin status';
          color = (csv_data[i][24] != '')? csv_data[i][24] : '#989898';
          link = (csv_data[i][20] != '')? '<a style="color:#212529;text-decoration: none;" href="'+csv_data[i][20]+'" target="_blank">VER MAPA</a>' : '';
          tiulo_proyecto = csv_data[i][1] + " - " + csv_data[i][2];
          titulo = csv_data[i][4];
          gerencia = csv_data[i][6];
          tematica_prin = csv_data[i][9];
          tematica_sec = csv_data[i][10];
          analisis = csv_data[i][11];
          miniatura = (csv_data[i][20] != '')? csv_data[i][20].replace("open", "thumbnail")+"&sz=w400-h300-p-k-nu" : csv_data[i][20];

          $("#table").append("<div class='col-3'><div class='sombra card mb-3' style='background-color: "+color+" !important;'><div class='card-header' style='background: linear-gradient(to bottom, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.6) 100%), url("+miniatura+") no-repeat;'><ul class='list-group' style='color: "+color+";'><li class='list-group-item' style='background-color: #00000000; border-color: "+color+" !important;'>"+gerencia+"</li></ul><label class='mt-3' style='color: "+color+";'>"+tiulo_proyecto+"</label></div><div class='card-body'><p class='card-text'>"+titulo+"</p></div><div class='card-footer bg-transparent'>"+link+"</div></div></div>");
        }
      }
      function changePagination(orientation){
        switch(orientation){
          case 'next':
            if(page < totalPages){
              start_pagination += 25;
              limit_pagination += 25;
              page++;
              $("#page_back_top").removeClass("disabled");
              $("#page_back_bottom").removeClass("disabled");
              buildElements(data_csv, start_pagination, limit_pagination);
            }
            else{
              $("#page_next_top").addClass("disabled");
              $("#page_next_bottom").addClass("disabled");
            }

            $("#pagination_top").html("Página "+page+" - "+totalPages+" / "+data_csv.length);
            $("#pagination_bottom").html("Página "+page+" - "+totalPages+" / "+data_csv.length);
            break;
          case 'back':
            if(page === 1){
              start_pagination = 1;
              limit_pagination = 25;
              buildElements(data_csv, start_pagination, limit_pagination);
              $("#page_back_top").addClass("disabled");
              $("#page_back_bottom").addClass("disabled");
            }
            else{
              start_pagination -= 25;
              limit_pagination -= 25;
              page--;
              buildElements(data_csv, start_pagination, limit_pagination);
              $("#page_back_top").removeClass("disabled");
              $("#page_back_bottom").removeClass("disabled");
              $("#page_next_top").removeClass("disabled");
              $("#page_next_bottom").removeClass("disabled");
            }
            
            $("#pagination_top").html("Página "+page+" - "+totalPages+" / "+data_csv.length);
            $("#pagination_bottom").html("Página "+page+" - "+totalPages+" / "+data_csv.length);
            break;
        }
      }
      function filter(){
        temp = [];
        //check all filter
        var status_filter = ($("#filtro_status").val()) ? $("#filtro_status").val() : 0;
        var gerencia_filter = ($("#filtro_gerencia").val()) ? $("#filtro_gerencia").val() : 0;
        var tema_prin_filter = ($("#filtro_tematica_prin").val()) ? $("#filtro_tematica_prin").val() : 0;
        var tema_sec_filter = ($("#filtro_tematica_sec").val()) ? $("#filtro_tematica_sec").val() : 0;
        var analisis_filter = ($("#filtro_analisis").val()) ? $("#filtro_analisis").val() : 0;
        var libre_filter = $("#filtro_libre").val();

        
        if(status_filter != 0){
          /*if(temp.length === 0){
            for(var j = 0; j < status_filter.length; j++){
              for (var i = 1; i < data_csv.length; i++) {
                if(data_csv[i].indexOf(status_filter[j]) > 0){
                  //temp.push(data_csv[i]);
                  console.log(i)
                }
              }
            }
          }
          else{
            for(var j = 0; j < status_filter.length; j++){
              for(var i = 0; i < temp.length; i++){
                if(status_filter[j] != temp[i][5]){
                  temp.slice(i);
                }
              }
            }
          }*/
          //console.log(data_csv.filter(function (str) { return str.indexOf(PATTERN) === -1; }));
        }
        /*if(gerencia_filter != 0){
          for(var j = 0; j < gerencia_filter.length; j++){
            if(temp.length === 0){
              for (var i = 1; i < data_csv.length; i++) {
                if(gerencia_filter[j] === data_csv[i][6]){
                  temp.push(data_csv[i]);
                }
              }
            }
            else{
              for(var i = 0; i < temp.length; i++){
                if(gerencia_filter[j] != temp[i][6]){
                  temp.slice(i);
                }
              }
            }
          }
        }
        if(tema_prin_filter != 0){
          for(var j = 0; j < tema_prin_filter.length; j++){
            if(temp.length === 0){
              for (var i = 1; i < data_csv.length; i++) {
                if(tema_prin_filter[j] === data_csv[i][9]){
                  temp.push(data_csv[i]);
                }
              }
            }
            else{
              for(var i = 0; i < temp.length; i++){
                if(tema_prin_filter[j] != temp[i][9]){
                  temp.slice(i);
                }
              }
            }
          }
        }
        if(tema_sec_filter != 0){
          for(var j = 0; j < tema_sec_filter.length; j++){
            if(temp.length === 0){
              for (var i = 1; i < data_csv.length; i++) {
                if(tema_sec_filter[j] === data_csv[i][10]){
                  temp.push(data_csv[i]);
                }
              }
            }
            else{
              for(var i = 0; i < temp.length; i++){
                if(tema_sec_filter[j] != temp[i][10]){
                  temp.slice(i);
                }
              }
            }
          }
        }
        if(analisis_filter != 0){
          for(var j = 0; j < analisis_filter.length; j++){
            if(temp.length === 0){
              for (var i = 1; i < data_csv.length; i++) {
                if(analisis_filter[j] === data_csv[i][11]){
                  temp.push(data_csv[i]);
                }
              }
            }
            else{
              for(var i = 0; i < temp.length; i++){
                if(analisis_filter[j] != temp[i][11]){
                  temp.slice(i);
                }
              }
            }
          }
        }
        /*if(libre_filter != 0){
          if((data_csv[i][1].indexOf(libre_filter) != -1 && data_csv[i][1] != '') || (data_csv[i][4].indexOf(libre_filter) != -1 && data_csv[i][4] != '')){
              console.log(libre_filter + " found");
          }
        }*/
        
        console.log(temp)
        start_pagination = 1;
        limit_pagination = 25;
        page = 1;

        if(temp.length > 0){
          buildElements(temp, start_pagination, limit_pagination);
          totalPages = Math.ceil(temp.length / 25);
        }
        else{
          buildElements(data_csv, start_pagination, limit_pagination);
          totalPages = Math.ceil(data_csv.length / 25);
        }
        
        $("#pagination_top").html("Página "+page+" - "+totalPages+" / "+data_csv.length);
        $("#pagination_bottom").html("Página "+page+" - "+totalPages+" / "+data_csv.length);
        $("#page_back_top").addClass("disabled");
        $("#page_back_bottom").addClass("disabled");
        $("#page_next_top").removeClass("disabled");
        $("#page_next_bottom").removeClass("disabled");
      }
      /*text filtra por tiulo_proyecto y por titulo*/
    </script>
  </body>
</html>
